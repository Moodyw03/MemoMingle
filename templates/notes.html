<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Cloud Diary - My Notes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style.css') }}"
    />
  </head>
  <body>
    <!-- Success -->
    {% if success %}
    <div id="success">
      <p>{{ success }}</p>
    </div>
    {% endif %}

    <!-- Error -->
    {% if error %}
    <div id="error">
      <p>{{ error }}</p>
    </div>
    {% endif %}

    <!-- NAV -->
    <nav class="notes__nav">
      <div class="written-note">
        <a href="{{ url_for('note.get_notes') }}" title="My Cloud Diary">
          <img
            class="memologo"
            src="{{ url_for('static', filename='images/myclouddiary.png') }}"
            alt="My Cloud Diary logo"
          />
        </a>
        <a
          class="memo"
          href="{{ url_for('note.get_notes') }}"
          title="My Cloud Diary"
        >
          <h2>
            <strong class="">My Cloud Diary</strong>
            <span class="slogan">
              <span>Capture your thoughts.</span>
              <span>Keep them forever!</span>
            </span>
          </h2>
        </a>
      </div>

      <!-- Search bar -->
      <form
        class="notes__nav--search"
        action="{{ url_for('note.search_notes') }}"
        method="POST"
      >
        <input
          class="notes__nav--search--input"
          type="text"
          name="search"
          placeholder="Search"
          value="{% if search %}{{ search }}{% endif %}"
        />
        <button class="notes__nav--search--button" type="submit">
          <img
            class="notes__nav--search--button--icon"
            src="https://unpkg.com/lucide-static@latest/icons/search.svg"
          />
        </button>
      </form>
      <div class="notes__nav--logout">
        <a href="{{ url_for('auth.sign_out') }}" title="Sign Out">
          <img src="https://unpkg.com/lucide-static@latest/icons/log-out.svg" />
        </a>
      </div>

      <!-- Sign Out -->
    </nav>

    <!-- NEW NOTE -->
    <section class="notes_new_section">
      <form
        class="notes__form"
        action="{{ url_for('note.create_note') }}"
        method="POST"
      >
        <input
          class="notes__form--input title"
          type="text"
          name="title"
          placeholder="TITLE"
          value=""
        />

        <textarea
          class="notes__form--input textarea"
          name="content"
          placeholder="A new note ..."
          rows="6"
          wrap="soft"
        ></textarea>

        <button class="notes__form--button" type="submit">
          <img src="https://unpkg.com/lucide-static@latest/icons/send.svg" />
        </button>

        <input
          class="notes__form--input tags"
          type="text"
          name="tags"
          placeholder="tags (';' separated)"
          value=""
        />
      </form>
    </section>

    <section class="notes__section">
      <!-- NOTES -->
      {% if notes %}
      <div class="notes">
        {% for note in notes %}
        <div class="note">
          <a
            href="{{ url_for('note.edit_note', note_id=note.id) }}"
            class="notes__container"
          >
            <h3 class="notes__container--title">{{ note.title }}</h3>
            <p class="notes__container--content">{{ note.content | nl2br }}</p>
            <div class="notes__container--metadata">
              <div class="notes__container--tags">
                {% for tag in note.tags %}
                <span class="notes__container--tags--tag">{{ tag }}</span>
                {% endfor %}
              </div>
              <div class="notes__container--date">
                <!-- Using lowercase column names for Supabase and ISO date parsing -->
                {% set lastmod = note.lastmodified %}
                {% if lastmod is string %}
                  {% set lastmod_date = lastmod.split('T')[0] %}
                  {% set lastmod_time = lastmod.split('T')[1].split('.')[0] %}
                  <div>
                    <span>{{ lastmod_date }}</span>
                    <span>{{ lastmod_time }}</span>
                  </div>
                {% else %}
                  <div>{{ lastmod }}</div>
                {% endif %}
              </div>
            </div>
            <div class="notes__container--actions">
              <!-- Delete note -->
              <form
                action="{{ url_for('note.delete_note', note_id=note.id) }}"
                method="post"
              >
                <button type="submit" class="notes__container--actions--button">
                  <img
                    src="https://unpkg.com/lucide-static@latest/icons/trash-2.svg"
                  />
                </button>
              </form>
            </div>
          </a>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="notes__empty">
        <p>No notes yet</p>
      </div>
      {% endif %}
    </section>

    {% include 'footer.html' %}

    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
  </body>
</html>
